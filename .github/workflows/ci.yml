# SPDX-FileCopyrightText: 2022  Emmanuele Bassi
# SPDX-License-Identifier: GPL-3.0-or-later

name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows-static:
    name: Build Windows (Static)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gtk4
          mingw-w64-x86_64-libadwaita
          mingw-w64-x86_64-gstreamer
          mingw-w64-x86_64-gst-plugins-base
          mingw-w64-x86_64-gst-plugins-good
          mingw-w64-x86_64-gst-plugins-bad
          mingw-w64-x86_64-gst-plugins-ugly
          mingw-w64-x86_64-gst-libav
          mingw-w64-x86_64-rust
          mingw-w64-x86_64-meson
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-gettext
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-gcc-libs

    - name: Configure and Build Static Version
      run: |
        # Set environment for static linking
        export PKG_CONFIG_ALL_STATIC=1
        export PKG_CONFIG_ALLOW_CROSS=1
        export GSTREAMER_1_0_STATIC=1
        export GTK4_STATIC=1
        export RUSTFLAGS="-C target-feature=+crt-static -C link-arg=-static -C link-arg=-static-libgcc -C link-arg=-static-libstdc++"
        
        echo "üîß Configuring static build..."
        meson setup _build --buildtype=release --default-library=static --prefer-static
        
        echo "üèóÔ∏è Building static executable..."
        meson compile -C _build
        
        echo "‚úÖ Build completed!"

    - name: Create Static Distribution
      shell: pwsh
      run: |
        # Create static distribution directory
        $distDir = "amberol-windows-static"
        $binDir = "$distDir\bin"
        
        New-Item -ItemType Directory -Force -Path $binDir
        
        # Copy the statically linked executable
        Copy-Item "_build\src\amberol.exe" $binDir -Force
        
        # Copy documentation files
        Copy-Item "README-Windows.md" $distDir -Force
        Copy-Item "LICENSES\GPL-3.0-or-later.txt" "$distDir\LICENSE.txt" -Force
        Copy-Item "README-Windows-Static.md" $distDir -Force
        
        # Create simple launcher for static build
        $staticLauncher = @"
        @echo off
        REM Amberol Static Build - Self-contained executable
        REM All dependencies are statically linked - no external DLLs required
        
        setlocal
        set AMBEROL_DIR=%~dp0
        
        if not defined LOCALAPPDATA (
            set LOCALAPPDATA=%USERPROFILE%\AppData\Local
        )
        
        if not exist "%LOCALAPPDATA%\io.bassi.Amberol" (
            mkdir "%LOCALAPPDATA%\io.bassi.Amberol"
        )
        
        echo Starting Amberol (Static Build - Self-Contained)...
        "%AMBEROL_DIR%bin\amberol.exe" %*
        
        if %ERRORLEVEL% neq 0 (
            echo.
            echo Error: Amberol failed to start (exit code: %ERRORLEVEL%)
            echo.
            echo This is a static build with all dependencies included.
            echo Troubleshooting:
            echo - Ensure Windows 10 version 1809 or Windows 11
            echo - Check that Windows Audio service is running
            echo - Verify audio drivers are properly installed
            echo - Try running as Administrator if needed
            echo.
            pause
        )
        endlocal
        "@
        
        Set-Content -Path "$distDir\amberol.bat" -Value $staticLauncher

    - name: Analyze Static Build
      shell: pwsh
      run: |
        $exePath = "amberol-windows-static\bin\amberol.exe"
        
        if (Test-Path $exePath) {
            # Get executable size
            $exeSize = (Get-Item $exePath).Length / 1MB
            Write-Host "üìä Static executable size: $($exeSize.ToString('F2')) MB" -ForegroundColor Green
            
            # Try to check dependencies (should be minimal for static build)
            try {
                $dependencies = & objdump -p $exePath | Select-String "DLL Name:" | Select-Object -First 10
                if ($dependencies) {
                    Write-Host "üîç Runtime dependencies:" -ForegroundColor Yellow
                    $dependencies | ForEach-Object { Write-Host "  $_" }
                } else {
                    Write-Host "‚úÖ No external DLL dependencies detected!" -ForegroundColor Green
                }
            } catch {
                Write-Host "‚ö†Ô∏è Could not analyze dependencies (objdump not available)" -ForegroundColor Yellow
            }
            
            # Check file properties
            Write-Host "üìã File details:" -ForegroundColor Blue
            Write-Host "  Path: $exePath"
            Write-Host "  Size: $($exeSize.ToString('F2')) MB"
            Write-Host "  Type: Static-linked executable"
        } else {
            Write-Error "‚ùå Static executable not found at $exePath"
        }

    - name: Create Static Package
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path dist
        
        # Create static build ZIP
        Compress-Archive -Path "amberol-windows-static\*" -DestinationPath "dist\amberol-windows-static.zip"
        
        # Show package information
        $packageSize = (Get-Item "dist\amberol-windows-static.zip").Length / 1MB
        $exeSize = (Get-Item "amberol-windows-static\bin\amberol.exe").Length / 1MB
        
        Write-Host "üì¶ Static Build Package Summary:" -ForegroundColor Green
        Write-Host "  Package: amberol-windows-static.zip ($($packageSize.ToString('F2')) MB)" -ForegroundColor Yellow
        Write-Host "  Executable: amberol.exe ($($exeSize.ToString('F2')) MB)" -ForegroundColor Yellow
        Write-Host "  Dependencies: None (fully static)" -ForegroundColor Yellow
        Write-Host "  Target: Windows 10/11 x64" -ForegroundColor Yellow

    - name: Upload Static Build
      uses: actions/upload-artifact@v4
      with:
        name: amberol-windows-static
        path: dist/