# SPDX-FileCopyrightText: 2022  Emmanuele Bassi
# SPDX-License-Identifier: GPL-3.0-or-later

name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows-portable:
    name: Build Windows (Self-Contained Portable)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gtk4
          mingw-w64-x86_64-libadwaita
          mingw-w64-x86_64-gstreamer
          mingw-w64-x86_64-gst-plugins-base
          mingw-w64-x86_64-gst-plugins-good
          mingw-w64-x86_64-gst-plugins-bad
          mingw-w64-x86_64-gst-plugins-ugly
          mingw-w64-x86_64-gst-libav
          mingw-w64-x86_64-rust
          mingw-w64-x86_64-meson
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-gettext
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-gcc-libs

    - name: Create Portable Build with All DLLs
      run: |
        echo "üèóÔ∏è Creating comprehensive portable build with all dependencies..."
        
        # Set up for dynamic linking (accepting that true static isn't feasible)
        export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:/mingw64/share/pkgconfig"
        
        echo "üîß Configuring for portable build..."
        meson setup _build --buildtype=release
        
        echo "üèóÔ∏è Building..."
        meson compile -C _build
        
        echo "‚úÖ Build completed!"

    - name: Create Self-Contained Portable Distribution
      shell: pwsh
      run: |
        # Create distribution directory
        $distDir = "amberol-windows-static"
        $binDir = "$distDir\bin"
        $libDir = "$distDir\lib"
        $shareDir = "$distDir\share"
        
        New-Item -ItemType Directory -Force -Path $binDir, $libDir, $shareDir
        
        Write-Host "üìÅ Creating self-contained portable distribution..." -ForegroundColor Green
        
        # Copy main executable
        Copy-Item "_build\src\amberol.exe" $binDir -Force
        
        # Copy ALL possible DLLs to ensure it's truly portable
        Write-Host "üì¶ Copying comprehensive DLL set..." -ForegroundColor Blue
        $allDlls = @(
          # Core GTK4/libadwaita
          "libgtk-4-1.dll", "libadwaita-1-0.dll", "libgraphene-1.0-0.dll",
          
          # GStreamer audio
          "libgstreamer-1.0-0.dll", "libgstbase-1.0-0.dll", "libgstaudio-1.0-0.dll", 
          "libgstplayer-1.0-0.dll", "libgstvideo-1.0-0.dll", "libgstpbutils-1.0-0.dll",
          "libgsttag-1.0-0.dll", "libgstapp-1.0-0.dll",
          
          # Core GLib/GObject
          "libglib-2.0-0.dll", "libgobject-2.0-0.dll", "libgio-2.0-0.dll",
          "libgmodule-2.0-0.dll", "libgthread-2.0-0.dll",
          
          # Graphics and rendering
          "libcairo-2.dll", "libcairo-gobject-2.dll", "libpango-1.0-0.dll",
          "libpangocairo-1.0-0.dll", "libpangowin32-1.0-0.dll", "libpangoft2-1.0-0.dll",
          "libharfbuzz-0.dll", "libfreetype-6.dll", "libfontconfig-1.dll",
          "libpixman-1-0.dll", "librsvg-2-2.dll",
          
          # Image formats
          "libpng16-16.dll", "libjpeg-8.dll", "libtiff-5.dll", "libwebp-7.dll",
          "libwebpmux-3.dll", "libwebpdemux-2.dll",
          
          # Text and internationalization
          "libintl-8.dll", "libiconv-2.dll", "libfribidi-0.dll",
          
          # XML and data
          "libxml2-2.dll", "libexpat-1.dll", "liblzma-5.dll", "libbz2-1.dll",
          
          # Compression
          "zlib1.dll", "libbrotlidec.dll", "libbrotlicommon.dll", "libbrotlienc.dll",
          
          # SSL/Network (if needed)
          "libssl-3-x64.dll", "libcrypto-3-x64.dll",
          
          # Audio formats and codecs
          "libvorbis-0.dll", "libvorbisenc-2.dll", "libvorbisfile-3.dll",
          "libogg-0.dll", "libopus-0.dll", "libopusfile-0.dll",
          "libFLAC-8.dll", "libsndfile-1.dll", "libmpg123-0.dll",
          
          # System libraries
          "libffi-7.dll", "libpcre-1.dll", "libpcre2-8-0.dll",
          "libwinpthread-1.dll", "libgcc_s_seh-1.dll", "libstdc++-6.dll"
        )
        
        $copiedDlls = 0
        $missingDlls = @()
        
        foreach ($dll in $allDlls) {
          $source = "C:\msys64\mingw64\bin\$dll"
          if (Test-Path $source) {
            Copy-Item $source $binDir -Force
            $copiedDlls++
          } else {
            $missingDlls += $dll
          }
        }
        
        Write-Host "‚úÖ Copied $copiedDlls DLLs" -ForegroundColor Green
        if ($missingDlls.Count -gt 0) {
          Write-Host "‚ö†Ô∏è Missing DLLs (may not be needed): $($missingDlls.Count)" -ForegroundColor Yellow
        }
        
        # Copy ALL GStreamer plugins
        Write-Host "üì¶ Copying all GStreamer plugins..." -ForegroundColor Blue
        $gstPluginDir = "C:\msys64\mingw64\lib\gstreamer-1.0"
        if (Test-Path $gstPluginDir) {
          Copy-Item $gstPluginDir "$libDir\gstreamer-1.0" -Recurse -Force
          $pluginCount = (Get-ChildItem "$libDir\gstreamer-1.0" -Filter "*.dll").Count
          Write-Host "‚úÖ Copied $pluginCount GStreamer plugins" -ForegroundColor Green
        }
        
        # Copy GLib schemas
        $glibSchemas = "C:\msys64\mingw64\share\glib-2.0"
        if (Test-Path $glibSchemas) {
          Copy-Item $glibSchemas "$shareDir\glib-2.0" -Recurse -Force
        }
        
        # Copy application resources
        Copy-Item "_build\data\*.gresource" $shareDir -ErrorAction SilentlyContinue
        
        # Copy documentation
        Copy-Item "README-Windows.md" $distDir -Force
        Copy-Item "LICENSES\GPL-3.0-or-later.txt" "$distDir\LICENSE.txt" -Force
        
        # Create enhanced launcher that sets up complete environment
        $launcher = @"
        @echo off
        REM Amberol Portable - Self-Contained with All Dependencies
        REM This version includes ALL required DLLs and should work without external dependencies
        
        setlocal
        set AMBEROL_DIR=%~dp0
        
        REM Set up GStreamer environment
        set GST_PLUGIN_PATH=%AMBEROL_DIR%lib\gstreamer-1.0
        set GST_PLUGIN_SYSTEM_PATH=%AMBEROL_DIR%lib\gstreamer-1.0
        set GST_REGISTRY=%AMBEROL_DIR%gst-registry.bin
        
        REM Set up GLib environment
        set GSETTINGS_SCHEMA_DIR=%AMBEROL_DIR%share\glib-2.0\schemas
        
        REM Add DLL directory to PATH
        set PATH=%AMBEROL_DIR%bin;%PATH%
        
        REM Set GTK preferences
        set GSK_RENDERER=gl
        set GTK_USE_PORTAL=0
        
        REM Set application data directory
        if not defined LOCALAPPDATA (
            set LOCALAPPDATA=%USERPROFILE%\AppData\Local
        )
        
        if not exist "%LOCALAPPDATA%\io.bassi.Amberol" (
            mkdir "%LOCALAPPDATA%\io.bassi.Amberol"
        )
        
        echo Starting Amberol (Self-Contained Portable)...
        echo All dependencies included - no system installation required
        
        "%AMBEROL_DIR%bin\amberol.exe" %*
        
        if %ERRORLEVEL% neq 0 (
            echo.
            echo Error: Amberol failed to start (exit code: %ERRORLEVEL%)
            echo.
            echo This is a self-contained portable build.
            echo Troubleshooting:
            echo 1. Ensure Windows 10 version 1809 or Windows 11
            echo 2. Check Windows Audio service is running
            echo 3. Update audio drivers
            echo 4. Try running as Administrator
            echo 5. Check antivirus isn't blocking the application
            echo.
            echo Debug information:
            echo - GST_PLUGIN_PATH: %GST_PLUGIN_PATH%
            echo - Current directory: %CD%
            echo - PATH: %PATH%
            echo.
            pause
        )
        endlocal
        "@
        
        Set-Content -Path "$distDir\amberol.bat" -Value $launcher
        
        # Calculate total size
        $totalSize = (Get-ChildItem $distDir -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host "üìä Total portable package size: $($totalSize.ToString('F2')) MB" -ForegroundColor Green

    - name: Analyze Portable Build
      shell: pwsh
      run: |
        # Find the executable in the distribution directory
        $exePath = "amberol-windows-static\bin\amberol.exe"
        
        if (Test-Path $exePath) {
            # Get executable size
            $exeSize = (Get-Item $exePath).Length / 1MB
            Write-Host "üìä Executable size: $($exeSize.ToString('F2')) MB" -ForegroundColor Green
            
            # Count included DLLs
            $dllCount = (Get-ChildItem "amberol-windows-static\bin" -Filter "*.dll").Count
            $pluginCount = if (Test-Path "amberol-windows-static\lib\gstreamer-1.0") { 
                (Get-ChildItem "amberol-windows-static\lib\gstreamer-1.0" -Filter "*.dll").Count 
            } else { 0 }
            
            Write-Host "üì¶ Portable Build Analysis:" -ForegroundColor Blue
            Write-Host "  Executable: $($exeSize.ToString('F2')) MB" -ForegroundColor Green
            Write-Host "  DLLs included: $dllCount" -ForegroundColor Green
            Write-Host "  GStreamer plugins: $pluginCount" -ForegroundColor Green
            
            # Calculate total package size
            $totalSize = (Get-ChildItem "amberol-windows-static" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
            Write-Host "  Total package: $($totalSize.ToString('F2')) MB" -ForegroundColor Green
            
            # List some key DLLs to verify they're included
            Write-Host "üîç Key dependencies included:" -ForegroundColor Blue
            $keyDlls = @("libgtk-4-1.dll", "libadwaita-1-0.dll", "libgstreamer-1.0-0.dll", "libgstaudio-1.0-0.dll", "libgstplayer-1.0-0.dll")
            foreach ($dll in $keyDlls) {
                $path = "amberol-windows-static\bin\$dll"
                if (Test-Path $path) {
                    $size = [math]::Round((Get-Item $path).Length / 1KB, 1)
                    Write-Host "  ‚úÖ $dll ($size KB)" -ForegroundColor Green
                } else {
                    Write-Host "  ‚ùå $dll (missing)" -ForegroundColor Red
                }
            }
            
            Write-Host "üéØ RESULT: Self-contained portable build created!" -ForegroundColor Green
            Write-Host "   This package should run on Windows 10/11 without any additional dependencies" -ForegroundColor Green
            Write-Host "   Users can simply extract and run amberol.bat" -ForegroundColor Green
            
        } else {
            Write-Error "‚ùå Executable not found at $exePath"
            Write-Host "üîç Checking distribution directory contents:" -ForegroundColor Yellow
            Get-ChildItem "amberol-windows-static" -Recurse | ForEach-Object { Write-Host "  $_" }
        }

    - name: Create Portable Package
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path dist
        
        # Create comprehensive portable build ZIP
        Compress-Archive -Path "amberol-windows-static\*" -DestinationPath "dist\amberol-windows-portable.zip"
        
        # Show package information
        $packageSize = (Get-Item "dist\amberol-windows-portable.zip").Length / 1MB
        $exeSize = (Get-Item "amberol-windows-static\bin\amberol.exe").Length / 1MB
        $dllCount = (Get-ChildItem "amberol-windows-static\bin" -Filter "*.dll").Count
        
        Write-Host "üì¶ Self-Contained Portable Package Summary:" -ForegroundColor Green
        Write-Host "  Package: amberol-windows-portable.zip ($($packageSize.ToString('F2')) MB)" -ForegroundColor Yellow
        Write-Host "  Executable: amberol.exe ($($exeSize.ToString('F2')) MB)" -ForegroundColor Yellow
        Write-Host "  Dependencies: $dllCount DLLs included" -ForegroundColor Yellow
        Write-Host "  Target: Windows 10/11 x64 (no system dependencies)" -ForegroundColor Yellow
        Write-Host "  Installation: Extract and run amberol.bat" -ForegroundColor Yellow

    - name: Upload Portable Build
      uses: actions/upload-artifact@v4
      with:
        name: amberol-windows-portable
        path: dist/