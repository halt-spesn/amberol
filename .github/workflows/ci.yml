# SPDX-FileCopyrightText: 2022  Emmanuele Bassi
# SPDX-License-Identifier: GPL-3.0-or-later

name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows-static:
    name: Build Windows (Static)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gtk4
          mingw-w64-x86_64-libadwaita
          mingw-w64-x86_64-gstreamer
          mingw-w64-x86_64-gst-plugins-base
          mingw-w64-x86_64-gst-plugins-good
          mingw-w64-x86_64-gst-plugins-bad
          mingw-w64-x86_64-gst-plugins-ugly
          mingw-w64-x86_64-gst-libav
          mingw-w64-x86_64-rust
          mingw-w64-x86_64-meson
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-gettext
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-gcc-libs
          mingw-w64-x86_64-graphene
          mingw-w64-x86_64-cairo
          mingw-w64-x86_64-pango
          mingw-w64-x86_64-glib2
          mingw-w64-x86_64-gobject-introspection

    - name: Attempt to Install Static Libraries
      run: |
        echo "üîç Attempting to install static/development packages..."
        
        # Try to install development packages that might contain static libraries
        pacman -S --noconfirm --needed \
          mingw-w64-x86_64-gtk4-devel \
          mingw-w64-x86_64-libadwaita-devel \
          mingw-w64-x86_64-gstreamer-devel \
          mingw-w64-x86_64-gst-plugins-base-devel \
          mingw-w64-x86_64-graphene-devel \
          mingw-w64-x86_64-cairo-devel \
          mingw-w64-x86_64-pango-devel \
          mingw-w64-x86_64-glib2-devel 2>/dev/null || echo "Some -devel packages not available"
        
        # Check what static libraries we actually have
        echo "üìã Available static libraries in /mingw64/lib:"
        find /mingw64/lib -name "*.a" | grep -E "(gtk|adwaita|gst|graphene)" | head -20 || echo "No matching static libraries found"

    - name: Configure and Build Static Version
      run: |
        echo "üöÄ Using comprehensive static build approach..."
        chmod +x build_true_static.sh
        ./build_true_static.sh

    - name: Create Static Distribution
      shell: pwsh
      run: |
        # Create static distribution directory
        $distDir = "amberol-windows-static"
        $binDir = "$distDir\bin"
        
        New-Item -ItemType Directory -Force -Path $binDir
        
        # Find the built executable from any of the possible build directories
        $possibleBuilds = @("_build_static", "_build_manual", "_build_fallback", "_build")
        $foundExe = $null
        
        foreach ($buildDir in $possibleBuilds) {
            $exePath = "$buildDir\src\amberol.exe"
            if (Test-Path $exePath) {
                $foundExe = $exePath
                Write-Host "‚úÖ Found executable in: $buildDir" -ForegroundColor Green
                break
            }
        }
        
        if (-not $foundExe) {
            Write-Error "‚ùå Could not find amberol.exe in any build directory"
            Write-Host "üîç Searching for any amberol.exe files..." -ForegroundColor Yellow
            Get-ChildItem -Path . -Name "amberol.exe" -Recurse | ForEach-Object { Write-Host "  Found: $_" }
            exit 1
        }
        
        # Copy the found executable
        Write-Host "üìÅ Copying executable from: $foundExe" -ForegroundColor Blue
        Copy-Item $foundExe $binDir -Force
        
        # Copy documentation files
        Copy-Item "README-Windows.md" $distDir -Force
        Copy-Item "LICENSES\GPL-3.0-or-later.txt" "$distDir\LICENSE.txt" -Force
        Copy-Item "README-Windows-Static.md" $distDir -Force
        
        # Create simple launcher for static build
        $staticLauncher = @"
        @echo off
        REM Amberol Static Build - Self-contained executable
        REM All dependencies are statically linked - no external DLLs required
        
        setlocal
        set AMBEROL_DIR=%~dp0
        
        if not defined LOCALAPPDATA (
            set LOCALAPPDATA=%USERPROFILE%\AppData\Local
        )
        
        if not exist "%LOCALAPPDATA%\io.bassi.Amberol" (
            mkdir "%LOCALAPPDATA%\io.bassi.Amberol"
        )
        
        echo Starting Amberol (Static Build - Self-Contained)...
        "%AMBEROL_DIR%bin\amberol.exe" %*
        
        if %ERRORLEVEL% neq 0 (
            echo.
            echo Error: Amberol failed to start (exit code: %ERRORLEVEL%)
            echo.
            echo This is a static build with all dependencies included.
            echo Troubleshooting:
            echo - Ensure Windows 10 version 1809 or Windows 11
            echo - Check that Windows Audio service is running
            echo - Verify audio drivers are properly installed
            echo - Try running as Administrator if needed
            echo.
            pause
        )
        endlocal
        "@
        
        Set-Content -Path "$distDir\amberol.bat" -Value $staticLauncher
        
        # Report which build was used
        $buildType = Split-Path (Split-Path $foundExe -Parent) -Leaf
        Write-Host "üìã Build Information:" -ForegroundColor Green
        Write-Host "  Source: $foundExe" -ForegroundColor Yellow
        Write-Host "  Build Type: $buildType" -ForegroundColor Yellow

    - name: Analyze Static Build
      shell: pwsh
      run: |
        # Find the executable in the distribution directory
        $exePath = "amberol-windows-static\bin\amberol.exe"
        
        if (Test-Path $exePath) {
            # Get executable size
            $exeSize = (Get-Item $exePath).Length / 1MB
            Write-Host "üìä Static executable size: $($exeSize.ToString('F2')) MB" -ForegroundColor Green
            
            # Check dependencies thoroughly
            Write-Host "üîç Analyzing dependencies..." -ForegroundColor Blue
            
            try {
                # Use objdump to check DLL dependencies
                $allDeps = & objdump -p $exePath 2>$null | Select-String "DLL Name:"
                $problematicDeps = $allDeps | Where-Object { $_ -match "(libgtk|libadwaita|libgst|libgraphene)" }
                
                if ($allDeps) {
                    Write-Host "üìã All runtime dependencies:" -ForegroundColor Yellow
                    $allDeps | ForEach-Object { Write-Host "  $_" -ForegroundColor Gray }
                    
                    if ($problematicDeps) {
                        Write-Host "‚ùå PROBLEM: Still has dynamic dependencies that should be static:" -ForegroundColor Red
                        $problematicDeps | ForEach-Object { Write-Host "  $_" -ForegroundColor Red }
                        Write-Host "üîß These should be statically linked but aren't!" -ForegroundColor Red
                        Write-Host "üí° The build may have fallen back to dynamic linking" -ForegroundColor Yellow
                    } else {
                        Write-Host "‚úÖ No problematic GTK/GStreamer DLL dependencies found!" -ForegroundColor Green
                    }
                } else {
                    Write-Host "‚úÖ No DLL dependencies detected - truly static!" -ForegroundColor Green
                }
                
                # Check for Windows system DLLs (these are OK)
                $systemDeps = $allDeps | Where-Object { $_ -match "(kernel32|user32|ntdll|msvcrt|advapi32)" }
                if ($systemDeps) {
                    Write-Host "‚ÑπÔ∏è System dependencies (normal for Windows):" -ForegroundColor Cyan
                    $systemDeps | ForEach-Object { Write-Host "  $_" -ForegroundColor Cyan }
                }
                
            } catch {
                Write-Host "‚ö†Ô∏è Could not analyze dependencies: $_" -ForegroundColor Yellow
                # Fallback: try alternative methods
                try {
                    Write-Host "üîÑ Trying PowerShell Get-Content approach..." -ForegroundColor Yellow
                    $content = Get-Content $exePath -Raw -Encoding Byte
                    $hasGtk = $content -match "gtk-4"
                    $hasAdwaita = $content -match "adwaita"
                    $hasGst = $content -match "gstreamer"
                    
                    if ($hasGtk -or $hasAdwaita -or $hasGst) {
                        Write-Host "‚úÖ Libraries appear to be embedded (found references in binary)" -ForegroundColor Green
                    } else {
                        Write-Host "‚ö†Ô∏è Could not detect library references in binary" -ForegroundColor Yellow
                    }
                } catch {
                    Write-Host "‚ö†Ô∏è All dependency analysis methods failed" -ForegroundColor Yellow
                }
            }
            
            # Check file properties and provide assessment
            Write-Host "üìã File Assessment:" -ForegroundColor Blue
            Write-Host "  Path: $exePath"
            Write-Host "  Size: $($exeSize.ToString('F2')) MB"
            
            # Size-based assessment
            if ($exeSize -lt 20) {
                Write-Host "  Status: ‚ùå Too small - likely dynamic linking" -ForegroundColor Red
                Write-Host "  Recommendation: Use portable build instead" -ForegroundColor Yellow
            } elseif ($exeSize -lt 50) {
                Write-Host "  Status: ‚ö†Ô∏è Small - partial static linking" -ForegroundColor Yellow  
                Write-Host "  Recommendation: May require some DLLs" -ForegroundColor Yellow
            } elseif ($exeSize -lt 150) {
                Write-Host "  Status: ‚úÖ Good size for static build" -ForegroundColor Green
                Write-Host "  Assessment: Likely fully or mostly static" -ForegroundColor Green
            } else {
                Write-Host "  Status: ‚ö†Ô∏è Very large - check for bloat" -ForegroundColor Yellow
                Write-Host "  Assessment: Fully static but potentially inefficient" -ForegroundColor Yellow
            }
            
            # Final recommendation
            if ($problematicDeps -and $problematicDeps.Count -gt 0) {
                Write-Host "üéØ RESULT: Hybrid build - some DLLs still required" -ForegroundColor Yellow
                Write-Host "   You may need to distribute this with the required DLLs" -ForegroundColor Yellow
            } elseif ($exeSize -gt 50) {
                Write-Host "üéØ RESULT: Appears to be a successful static build!" -ForegroundColor Green
                Write-Host "   Should run without external DLL dependencies" -ForegroundColor Green
            } else {
                Write-Host "üéØ RESULT: Build completed but static linking may be incomplete" -ForegroundColor Yellow
                Write-Host "   Test the executable to verify functionality" -ForegroundColor Yellow
            }
            
        } else {
            Write-Error "‚ùå Static executable not found at $exePath"
            Write-Host "üîç Checking distribution directory contents:" -ForegroundColor Yellow
            Get-ChildItem "amberol-windows-static" -Recurse | ForEach-Object { Write-Host "  $_" }
        }

    - name: Create Static Package
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path dist
        
        # Create static build ZIP
        Compress-Archive -Path "amberol-windows-static\*" -DestinationPath "dist\amberol-windows-static.zip"
        
        # Show package information
        $packageSize = (Get-Item "dist\amberol-windows-static.zip").Length / 1MB
        $exeSize = (Get-Item "amberol-windows-static\bin\amberol.exe").Length / 1MB
        
        Write-Host "üì¶ Static Build Package Summary:" -ForegroundColor Green
        Write-Host "  Package: amberol-windows-static.zip ($($packageSize.ToString('F2')) MB)" -ForegroundColor Yellow
        Write-Host "  Executable: amberol.exe ($($exeSize.ToString('F2')) MB)" -ForegroundColor Yellow
        Write-Host "  Dependencies: None (fully static)" -ForegroundColor Yellow
        Write-Host "  Target: Windows 10/11 x64" -ForegroundColor Yellow

    - name: Upload Static Build
      uses: actions/upload-artifact@v4
      with:
        name: amberol-windows-static
        path: dist/